
@php
use Carbon\Carbon;
@endphp

@extends('layouts.app')

@section('title', 'ุฅูุฌุงุฒุงุชู')

@section('content')
<link rel="stylesheet" href="{{ asset('css/Achievement.css') }}">

<div class="achievement-dashboard">
    <div class="dashboard-header">
        <div class="header-content">
            <h1 class="dashboard-title">{{ __('ุฅูุฌุงุฒู') }} - <span class="username">{{ $user->username }}</span></h1>
        </div>
        <div class="header-ornament"></div>
    </div>

    <div class="dashboard-grid">
        <!-- ูุงุฑุช ุงูููุงุท -->
        @php
            $fillPercent = ($pointsToNext > 0 && $nextLevel) ? (($totalPoints / ($totalPoints + $pointsToNext)) * 100) : ($currentLevel === 'ุฃุณุทูุฑุฉ' ? 100 : 0);
            $levelColors = [
                'ูุจุชุฏุฆ' => '#28a745',
                'ูุชูุณุท' => '#ffc107',
                'ูุญุชุฑู' => '#fd7e14',
                'ุฎุจูุฑ | ูุญุชุฑู' => '#dc3545',
                'ุฃุณุทูุฑุฉ' => '#6f42c1',
            ];
            $color = $levelColors[$currentLevel] ?? '#6c757d';
        @endphp

        <div class="dashboard-card points-card">
            <div class="card-decoration"></div>
            <div class="card-header">
                <span class="card-icon">๐ฏ</span>
                <h2 class="card-title">{{ __('ููุงุทู') }}</h2>
            </div>
            <div class="stat-item">
                <span class="stat-label">{{ __('ุงูููุงุท') }}:</span>
                <span class="stat-value">{{ $totalPoints }} {{ __('ููุทุฉ') }}</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">{{ __('ุงููุฑุญูุฉ ุงูุญุงููุฉ') }}:</span>
                <span class="stat-value">{{ $currentLevel }}</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">{{ __('ุงููุฑุญูุฉ ุงูุชุงููุฉ') }}:</span>
                <span class="stat-value">
                    @if ($currentLevel === 'ุฃุณุทูุฑุฉ')
                        ๐ {{ __('ุชูุงูููุง! ููุฏ ูุตูุช ุฅูู ุฃูุตู ูุณุชูู! ุงุณุชูุฑ ูู ุงูุชุฃูู!') }}
                    @else
                        {{ $nextLevel ?? __('ูุง ููุฌุฏ ูุณุชูู ุฃุนูู') }} โ {{ __('ุจุนุฏ') }} {{ $pointsToNext }} {{ __('ููุทุฉ') }}
                    @endif
                </span>
            </div>
            <div class="progress-container">
                <div class="progress-track">
                    <div class="progress-fill" style="width: {{ $fillPercent }}%; background-color: {{ $color }}"></div>
                </div>
                <div class="level-indicator">
                    <span class="current-level">{{ $currentLevel }}</span>
                    <span class="next-level">
                        @if ($currentLevel !== 'ุฃุณุทูุฑุฉ')
                            {{ __('ุงููุณุชูู ุงูุชุงูู') }}: {{ $nextLevel ?? __('ูุง ููุฌุฏ') }}
                        @else
                            {{ __('ุฃูุช ุงูุฃุณุทูุฑุฉ ๐ช') }}
                        @endif
                    </span>
                </div>
            </div>
            <button class="action-btn">{{ __('ุทุฑู ุงูุญุตูู ุนูู ุงูููุงุท') }}</button>
        </div>

        <!-- ูุงุฑุช ุงูุฎุทุฉ ุงูุฒูููุฉ -->
        @if ($planDuration > 0 && $planEndDate)
            @php
                $circleColor = ($progressPercent <= 33.33) ? '#28a745' : ($progressPercent <= 66.67 ? '#ffc107' : '#dc3545');
                $circumference = 2 * pi() * 45;
                $offset = $circumference * (1 - ($daysLeft / $planDuration));
            @endphp
            <div class="dashboard-card plan-card">
                <div class="card-header">
                    <span class="card-icon">โณ</span>
                    <h2 class="card-title">{{ __('ุงูุฎุทุฉ ุงูุฒูููุฉ') }}</h2>
                </div>
                <div class="stat-item">
                    <span class="stat-label">{{ __('ุงูุฃูุงู ุงููุชุจููุฉ') }}:</span>
                    <span class="stat-value" id="daysLeft">{{ $daysLeft }}</span> {{ __('ูู') }} {{ $planDuration }} {{ __('ููู') }}
                </div>
                <div class="stat-item">
                    <span class="stat-label">{{ __('ุชุงุฑูุฎ ุงูุงูุชูุงุก') }}:</span>
                    <span class="stat-value">{{ $planEndDate ? Carbon::parse($planEndDate)->format('Y-m-d') : __('ุบูุฑ ูุญุฏุฏ') }}</span>
                </div>
                <div class="circle-progress-container">
                    <svg width="100" height="100" class="circle-progress">
                        <circle class="circle-progress-bg" cx="50" cy="50" r="45"></circle>
                        <circle class="circle-progress-fill" cx="50" cy="50" r="45" stroke-dasharray="{{ $circumference }}" stroke-dashoffset="{{ $offset }}" style="stroke: {{ $circleColor }}"></circle>
                    </svg>
                    <div class="circle-progress-text">{{ $daysLeft }}</div>
                </div>
                <button class="action-btn" onclick="showPlanForm()">{{ __('ุชุนุฏูู ุงูุฎุทุฉ') }}</button>
                <div class="plan-form" id="planForm" style="display: none;">
                    <form method="POST" action="{{ route('achievement.index') }}">
                        @csrf
                        <input type="number" name="plan_duration" min="1" placeholder="{{ __('ุนุฏุฏ ุงูุฃูุงู') }}" required>
                        <button type="submit">{{ __('ุชุฃููุฏ ุงูุฎุทุฉ') }}</button>
                    </form>
                </div>
            </div>
        @elseif ($allContentCompleted)
            <div class="dashboard-card plan-card">
                <div class="card-header">
                    <span class="card-icon">โณ</span>
                    <h2 class="card-title">{{ __('ุงูุฎุทุฉ ุงูุฒูููุฉ') }}</h2>
                </div>
                <p>{{ __('ุชูุงูููุง! ููุฏ ุฃูููุช ุฌููุน ุงููุตูู ูุงููุฌุงูุงุช. ููููู ุงูุขู ุงุฎุชูุงุฑ ุงูุฎุทุฉ ุงูุฒูููุฉ ููุงูุชุญุงูุงุช.') }}</p>
                <button class="action-btn" onclick="showPlanForm()">{{ __('ุงุฎุชูุงุฑ ุงูุฎุทุฉ ุงูุฒูููุฉ') }}</button>
                <div class="plan-form" id="planForm" style="display: none;">
                    <form method="POST" action="{{ route('achievement.index') }}">
                        @csrf
                        <input type="number" name="plan_duration" min="1" placeholder="{{ __('ุนุฏุฏ ุงูุฃูุงู') }}" required>
                        <button type="submit">{{ __('ุชุฃููุฏ ุงูุฎุทุฉ') }}</button>
                    </form>
                </div>
            </div>
        @else
            <div class="dashboard-card plan-card">
                <div class="card-header">
                    <span class="card-icon">โณ</span>
                    <h2 class="card-title">{{ __('ุงูุฎุทุฉ ุงูุฒูููุฉ') }}</h2>
                </div>
                <p>{{ __('ูู ุชุจุฏุฃ ุจุนุฏ ูู ุฃู ุงุฎุชุจุงุฑุงุช. ุฃููู ุฌููุน ุงููุตูู ูุงููุฌุงูุงุช ูุชูุนูู ุฎุทุชู!') }}</p>
            </div>
        @endif

        <!-- ูุงุฑุช ุงูุฅุญุตุงุฆูุงุช -->
        <div class="dashboard-card stats-card">
            <div class="card-header">
                <span class="card-icon">๐</span>
                <h2 class="card-title">{{ __('ุฅุญุตุงุฆูุงุช ุงูุชูุฏู') }}</h2>
            </div>
            <div class="stats-grid">
                <div class="stat-circle">
                    <div class="circle-progress">
                        <div class="stat-number">{{ $completedDomains }}</div>
                    </div>
                    <div class="stat-name">{{ __('ุงููุฌุงูุงุช') }}</div>
                </div>
                <div class="stat-circle">
                    <div class="circle-progress">
                        <div class="stat-number">{{ $completedChapters }}</div>
                    </div>
                    <div class="stat-name">{{ __('ุงููุตูู') }}</div>
                </div>
                <div class="stat-circle">
                    <div class="circle-progress">
                        <div class="stat-number">{{ $completedExams }}</div>
                    </div>
                    <div class="stat-name">{{ __('ุงูุงูุชุญุงูุงุช') }}</div>
                </div>
                <div class="stat-circle">
                    <div class="circle-progress">
                        <div class="stat-number">{{ $completedQuestions }}</div>
                    </div>
                    <div class="stat-name">{{ __('ุงูุฃุณุฆูุฉ') }}</div>
                </div>
            </div>
        </div>

        <!-- ูุงุฑุช ุงูุฅูุฌุงุฒุงุช -->
        <div class="dashboard-card achievements-card">
            <div class="card-header">
                <span class="card-icon">๐</span>
                <h2 class="card-title">{{ __('ุฅูุฌุงุฒุงุชู') }}</h2>
            </div>
            <div class="achievements-container">
                <div class="achievement-badge gold">
                    <span class="badge-icon">๐ฅ</span>
                    <div class="badge-content">
                        <h3>{{ __('ุงููุฌุงูุงุช') }}</h3>
                        <p>{{ __('ุฃูููุช') }} {{ $completedDomains }} {{ __('ูุฌุงู') }}</p>
                    </div>
                </div>
                <div class="achievement-badge silver">
                    <span class="badge-icon">๐</span>
                    <div class="badge-content">
                        <h3>{{ __('ุงููุตูู') }}</h3>
                        <p>{{ __('ุฃูููุช') }} {{ $completedChapters }} {{ __('ูุตู') }}</p>
                    </div>
                </div>
                <div class="achievement-badge bronze">
                    <span class="badge-icon">๐ก</span>
                    <div class="badge-content">
                        <h3>{{ __('ุงูุฃุณุฆูุฉ') }}</h3>
                        <p>{{ __('ุฃุฌุจุช ุนูู') }} {{ $completedQuestions }} {{ __('ุณุคุงู') }}</p>
                    </div>
                </div>
                <div class="achievement-badge streak">
                    <span class="badge-icon">๐ฅ</span>
                    <div class="badge-content">
                        <h3>{{ __('ุงูุงุณุชูุฑุงุฑูุฉ') }}</h3>
                        <p>{{ $streakDays }} {{ __('ููู ุฏุฑุงุณุฉ ูุชุชุงูู') }}</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        function updateDaysLeft() {
            const endDate = "{{ $planEndDate ?? '' }}";
            const planDuration = {{ $planDuration ?? 1 }};
            if (endDate) {
                const end = new Date(endDate);
                const today = new Date();
                const diffTime = end - today;
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                const daysLeft = Math.max(0, diffDays);
                document.getElementById('daysLeft').textContent = daysLeft;

                // ุชุญุฏูุซ ุงูุฏุงุฆุฑุฉ
                const circumference = 2 * Math.PI * 45;
                const offset = circumference * (1 - (daysLeft / planDuration));
                const circle = document.querySelector('.circle-progress-fill');
                if (circle) {
                    circle.setAttribute('stroke-dashoffset', offset);
                    const progressPercent = (planDuration - daysLeft) / planDuration * 100;
                    if (progressPercent <= 33.33) {
                        circle.style.stroke = '#28a745'; // ุฃุฎุถุฑ
                    } else if (progressPercent <= 66.67) {
                        circle.style.stroke = '#ffc107'; // ุฃุตูุฑ
                    } else {
                        circle.style.stroke = '#dc3545'; // ุฃุญูุฑ
                    }
                }
            } else {
                document.getElementById('daysLeft').textContent = '0';
            }
        }

        function showPlanForm() {
            const planForm = document.getElementById('planForm');
            if (planForm) {
                planForm.style.display = planForm.style.display === 'none' ? 'block' : 'none';
            }
        }

        @if ($planDuration > 0 && $planEndDate)
            updateDaysLeft();
            setInterval(updateDaysLeft, 24 * 60 * 60 * 1000); // ุชุญุฏูุซ ูููู
        @endif
    </script>
</div>
@endsection