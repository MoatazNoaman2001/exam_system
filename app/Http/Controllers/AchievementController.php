<?php

namespace App\Http\Controllers;

use App\Models\Exam;
use App\Models\QuizAttempt;
use App\Models\TestAttempt;
use App\Models\ExamAttempt;
use App\Models\Domain;
use App\Models\Achievement;
use App\Models\Chapter;
use App\Models\SlideAttempt;
use App\Models\UserProgress;
use App\Notifications\UserAchievementNotification;
use Illuminate\Support\Facades\Auth;
use Carbon\Carbon;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\Notification;

class AchievementController extends Controller
{
    public function index(Request $request)
    {
        $user = Auth::user();

        // Fetch user progress
        $progress = UserProgress::where('user_id', $user->id)->first();

        // Plan duration variables
        $planDuration = session('plan_duration', 0);
        $planEndDate = session('plan_end_date');
        $daysLeft = $planEndDate ? max(0, Carbon::today()->diffInDays(Carbon::parse($planEndDate), false)) : 0;
        $progressPercent = ($planDuration > 0) ? (($planDuration - $daysLeft) / $planDuration) * 100 : 0;

        // Handle plan duration submission
        if ($request->has('plan_duration') && $request->filled('plan_duration')) {
            $planDuration = (int)$request->input('plan_duration');
            if ($planDuration > 0) {
                $planEndDate = Carbon::today()->addDays($planDuration);
                session([
                    'plan_duration' => $planDuration,
                    'plan_end_date' => $planEndDate,
                ]);
                $daysLeft = $planDuration;
                $progressPercent = 0;

                return redirect()->route('setting')->with('success', 'ูุจุฑูู! ููุฏ ุญุฏุฏุช ุฎุทุชู ุงูุฒูููุฉ ุจูุฌุงุญ! ๐ฏ ููุจุฏุฃ ุงูุฑุญูุฉ ูุญู ุงูุชููุฒ!');
            }
        }

        // ุญุณุงุจ ุงูููุงุท
        $completedLessons = SlideAttempt::where('user_id', $user->id)
                                       ->whereNotNull('end_date')
                                       ->count();
        $lessonPoints = $completedLessons * 50;

        $completedExams = ExamAttempt::where('user_id', $user->id)
                                     ->whereNotNull('ended_at')
                                     ->count();
        $examPoints = $completedExams * 100;

        $totalQuestions = QuizAttempt::where('user_id', $user->id)->sum('score') +
                          TestAttempt::where('user_id', $user->id)->sum('score');
        $questionPoints = floor($totalQuestions / 20) * 75;

        $completedAchievements = Achievement::where('user_id', $user->id)->count();
        $achievementPoints = $completedAchievements * 30;

        // ุญุณุงุจ streak ูููุงุทู
        $activityDates = SlideAttempt::where('user_id', $user->id)
                                    ->whereNotNull('end_date')
                                    ->pluck('end_date')
                                    ->merge(
                                        ExamAttempt::where('user_id', $user->id)
                                                   ->whereNotNull('ended_at')
                                                   ->pluck('ended_at')
                                    )
                                    ->merge(
                                        QuizAttempt::where('user_id', $user->id)
                                                   ->whereNotNull('created_at')
                                                   ->pluck('created_at')
                                    )
                                    ->merge(
                                        TestAttempt::where('user_id', $user->id)
                                                   ->whereNotNull('created_at')
                                                   ->pluck('created_at')
                                    )
                                    ->map(fn($date) => Carbon::parse($date)->startOfDay())
                                    ->unique()
                                    ->sort()
                                    ->values();

        $streakDays = 0;
        $today = Carbon::today();
        $currentStreak = 0;
        $hasRecentActivity = false;

        foreach ($activityDates as $date) {
            if ($date->equalTo($today) || $date->equalTo($today->subDay())) {
                $hasRecentActivity = true;
                break;
            }
        }

        if ($hasRecentActivity) {
            for ($i = $activityDates->count() - 1; $i >= 0; $i--) {
                $currentDate = $activityDates[$i];
                if ($currentDate->equalTo($today)) {
                    $currentStreak++;
                    $today = $today->subDay();
                } elseif ($currentDate->equalTo($today->subDay())) {
                    $currentStreak++;
                    $today = $today->subDay();
                } else {
                    break;
                }
            }
        }
        $streakDays = $currentStreak;
        $streakPoints = floor($streakDays / 3) * 20;

        $totalPoints = $lessonPoints + $examPoints + $questionPoints + $achievementPoints + $streakPoints;

        $latestExamAttempt = ExamAttempt::where('user_id', $user->id)
                                        ->whereNotNull('ended_at')
                                        ->latest('ended_at')
                                        ->first();

        if ($latestExamAttempt && $latestExamAttempt->score) {
            $totalScore = $latestExamAttempt->exam->total_score ?? 100;
            $scorePercentage = ($latestExamAttempt->score / $totalScore) * 100;

            $existingNotification = \DB::table('notifications')
                                       ->where('user_id', $user->id)
                                       ->where('text', 'like', '%ุงูุชุญุงู%')
                                       ->where('created_at', '>=', $latestExamAttempt->ended_at)
                                       ->exists();

            if (!$existingNotification) {
                if ($scorePercentage < 60) {
                    $user->notify(new UserAchievementNotification(
                        'exam_score_low',
                        'ูุง ุชููู! ูุฐู ูุฌุฑุฏ ุจุฏุงูุฉ ุฑุญูุชู ุงูุฑุงุฆุนุฉ! ๐',
                        'ุงูุงูุชุญุงู ุงููุงุฏู ุณูููู ุฃูุถู ุจูุซูุฑ! ุงุณุชูุฑ ูู ุงูุชุนูู ูุงููุญุงููุฉ!'
                    ));
                } elseif ($scorePercentage < 70) {
                    $user->notify(new UserAchievementNotification(
                        'exam_score_mid',
                        'ุฃูุช ุนูู ุงูุทุฑูู ุงูุตุญูุญ! ๐',
                        'ุจุงููุฒูุฏ ูู ุงูุฌูุฏ ุณุชุตู ุฅูู ุงูููุฉ! ูุญู ูุคูู ุจู!'
                    ));
                } elseif ($scorePercentage < 85) {
                    $user->notify(new UserAchievementNotification(
                        'exam_score_high',
                        'ุฃุญุณูุช! ุฃูุช ูุฑูุจ ุฌุฏุงู ูู ุงูุชููุฒ! โจ',
                        'ุงุณุชูุฑ ูู ุงูุชูุฏูุ ุงููุฌุงุญ ุงููุจูุฑ ููุชุธุฑู!'
                    ));
                }
            }
        }

        // ุชุญูู ูู ุฅููุงู ุงููุฌุงูุงุช
        $allDomains = Domain::count();
        $completedDomains = Domain::whereHas('slides', fn($query) => 
            $query->whereHas('slideAttempts', fn($q) => 
                $q->where('user_id', $user->id)->whereNotNull('end_date')
            )
        )->get()->filter(function ($domain) use ($user) {
            $totalSlides = $domain->slides()->count();
            $completedSlides = $domain->slides()->whereHas('slideAttempts', fn($q) => 
                $q->where('user_id', $user->id)->whereNotNull('end_date')
            )->count();
            return $totalSlides > 0 && $totalSlides === $completedSlides;
        })->count();

        if ($completedDomains > ($progress->domains_completed ?? 0)) {
            $user->notify(new UserAchievementNotification(
                'domain_completed',
                'ุฅูุฌุงุฒ ุฑุงุฆุน! ููุฏ ุฃุชููุช ูุฌุงูุงู ูุงููุงู! ๐',
                'ูู ุฎุทูุฉ ุชูุฑุจู ูู ุชุญููู ุฃุญูุงูู ุงููุจูุฑุฉ!'
            ));
        }

        // ุชุญูู ูู ุฅููุงู ุงููุตูู
        $allChapters = Chapter::count();
        $completedChapters = Chapter::whereHas('slides', fn($query) => 
            $query->whereHas('slideAttempts', fn($q) => 
                $q->where('user_id', $user->id)->whereNotNull('end_date')
            )
        )->get()->filter(function ($chapter) use ($user) {
            $totalSlides = $chapter->slides()->count();
            $completedSlides = $chapter->slides()->whereHas('slideAttempts', fn($q) => 
                $q->where('user_id', $user->id)->whereNotNull('end_date')
            )->count();
            return $totalSlides > 0 && $totalSlides === $completedSlides;
        })->count();

        if ($completedChapters > ($progress->lessons_completed ?? 0)) {
            $user->notify(new UserAchievementNotification(
                'chapter_completed',
                'ุชูุงูููุง ุงูุญุงุฑุฉ! ูุตู ุฌุฏูุฏ ุฃุถูุชู ุฅูู ุณุฌู ุฅูุฌุงุฒุงุชู! ๐',
                'ุงูุนูู ููุฑุ ููู ูุตู ุชูููู ูุถูุก ุทุฑููู ุฃูุซุฑ!'
            ));
        }

        // ุชุญูู ูู ุฅูุฌุงุฒุงุช ุงูุฃุณุฆูุฉ
        $completedQuestions = QuizAttempt::where('user_id', $user->id)->sum('score') +
                             TestAttempt::where('user_id', $user->id)->sum('score');
        $questionMilestone = floor($completedQuestions / 100) * 100;

        if ($completedQuestions >= $questionMilestone && $questionMilestone > ($progress->questions_completed ?? 0)) {
            $user->notify(new UserAchievementNotification(
                'question_milestone',
                "ูุฐูู! ููุฏ ุชุฌุงูุฒุช {$questionMilestone} ุณุคุงู! ๐คฏ",
                'ูู ุณุคุงู ุชุญูู ูุจูู ุนูููุง ุฃููู! ุงุณุชูุฑ ูู ุงูุชุญุฏู!'
            ));
        }

        // ุชุญุฏูุซ ุจูุงูุงุช ุงูุชูุฏู
        if ($progress) {
            $progress->points = $totalPoints;
            $progress->streak_days = $streakDays;
            $progress->domains_completed = $completedDomains;
            $progress->domains_total = $allDomains;
            $progress->lessons_completed = $completedChapters;
            $progress->lessons_total = $allChapters;
            $progress->exams_completed = $completedExams;
            $progress->questions_completed = $completedQuestions;
            $progress->save();
        }

        // ุญุณุงุจ ุงููุณุชูู ุงูุญุงูู
        $pointsMap = [
            'ูุจุชุฏุฆ' => 0,
            'ูุชูุณุท' => 150,
            'ูุชูุฏู' => 300,
            'ุฎุจูุฑ' => 500,
            'ุฃุณุทูุฑุฉ' => 800,
        ];

        $currentLevel = 'ูุจุชุฏุฆ';
        $nextLevel = null;
        $pointsToNext = 0;

        foreach ($pointsMap as $level => $threshold) {
            if ($totalPoints >= $threshold) {
                $currentLevel = $level;
            } else {
                $nextLevel = $level;
                $pointsToNext = $threshold - $totalPoints;
                break;
            }
        }

        if ($progress) {
            $progress->current_level = $currentLevel;
            $progress->save();
        }

        // ุชุญูู ุฅุฐุง ุชู ุฅููุงู ูู ุงููุญุชูู
        $allContentCompleted = ($allDomains > 0 && $allChapters > 0 && $completedDomains === $allDomains && $completedChapters === $allChapters);

        // ุนุฑุถ ุงูุจูุงูุงุช ุนูู ุงูุตูุญุฉ
        return view('student.Achievement', compact(
            'user',
            'progress',
            'totalPoints',
            'completedDomains',
            'completedChapters',
            'completedExams',
            'completedQuestions',
            'streakDays',
            'currentLevel',
            'nextLevel',
            'pointsToNext',
            'allContentCompleted',
            'planDuration',
            'planEndDate',
            'daysLeft',
            'progressPercent'
        ));
    }
}